<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8">
 <title>ç¤¾ä¼šç§‘ã‚¯ã‚¤ã‚º</title>
 <style>
   body {
     font-family: 'Segoe UI', sans-serif;
     background: #fff7e0;
     margin: 0;
     text-align: center;
     overflow-x: hidden;
   }


   .screen { display: none; }
   .fade { animation: fadein 1s ease; }
   @keyframes fadein { from { opacity: 0; } to { opacity: 1; } }


   #popup, #titleScreen, #game, #result, #ranking {
     padding: 30px;
   }


   button {
     font-size: 1.2em;
     padding: 10px 20px;
     border: none;
     background: #ffc526;
     color: white;
     border-radius: 10px;
     transition: all 0.4s ease;
     cursor: pointer;
   }


   button:hover {
     animation: buttonhover 0.4s;
     background: #ffdf87;
     font-size: 1.3em;
     padding: 13px 23px;
     border: none;
     border-radius: 13px;
     cursor: pointer;
   }


   button:hover:disabled {
     animation: unbuttonhover 0.4s
     font-size: 1.2em;
     padding: 10px 20px;
     border: none;
     background: #ffc526;
     color: white;
     border-radius: 10px;
     cursor: pointer;
   }


   input[type="text"] {
     font-size: 1.2em;
     padding: 5px;
     border-radius: 5px;
   }


   #timerBar {
     width: 100%;
     height: 20px;
     background: #eee;
     margin-top: 20px;
     border-radius: 10px;
     overflow: hidden;
   }


   #timerFill {
     height: 100%;
     background: #00acc1;
     width: 100%;
     transition: width 1s linear;
   }


   .score-bar {
     font-size: 1.1em;
     margin-bottom: 15px;
   }


   #qCard {
     background: white;
     padding: 20px;
     margin: 20px auto;
     width: 80%;
     max-width: 600px;
     border-radius: 20px;
     box-shadow: 0 4px 12px rgba(0,0,0,0.1);
     transition: transform 0.3s ease;
   }


   .correct-anim {
     animation: correctFlash 0.4s;
   }


   .wrong-anim {
     animation: wrongFlash 0.4s;
   }


   @keyframes correctFlash {
     0% { background-color: #ffffff; }
     50% { background-color: #a5d6a7; }
     100% { background-color: #ffffff; }
   }


   @keyframes wrongFlash {
     0% { background-color: #ffffff; }
     50% { background-color: #ef9a9a; }
     100% { background-color: #ffffff; }
   }


   @keyframes buttonhover {
     0% { font-size: 1.2em;
          padding: 10px 20px;
          border: none;
          background: #ffc526;
          color: white;
          border-radius: 10px;}


     100%{background: #ffdf87;
          font-size: 1.3em;
          padding: 13px 23px;
          border: none;
          border-radius: 13px;
          cursor: pointer;}
   }


   @keyframes unbuttonhover {
          0%{background: #ffdf87;
          font-size: 1.3em;
          padding: 13px 23px;
          border: none;
          border-radius: 13px;
          cursor: pointer;}
         
          100% { font-size: 1.2em;
          padding: 10px 20px;
          border: none;
          background: #ffc526;
          color: white;
          border-radius: 10px;}


    
   }
   .version-text {
     font-family:'arial black';
     font-weight:bold;
   }
 </style>
</head>
<body>
  <!-- âš ï¸ åˆå›æ³¨æ„ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
  <div id="popup" class="screen fade">
    <h2>âš ï¸ æ³¨æ„</h2>
    <p>
      ã“ã®ã‚¯ã‚¤ã‚ºã¯å­¦ç¿’ç›®çš„ã§æä¾›ã•ã‚Œã¾ã™ã€‚å„å•é¡Œã¯60ç§’ä»¥å†…ã«ç­”ãˆã¦ãã ã•ã„ã€‚<br>
      ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚å€‹äººæƒ…å ±ã«ã¤ãªãŒã‚‹åå‰ã®å…¥åŠ›ã¯é¿ã‘ã¦ãã ã•ã„ã€‚<br>
      ãƒˆãƒ©ãƒ–ãƒ«ãŒã‚ã£ãŸå ´åˆã¯é€šå ±ã«ã‚ˆã‚Šãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ãŒã€ãã®ä»–ã®è²¬ä»»ã¯è² ã„ã‹ã­ã¾ã™ã€‚<br>
      æœ¬è£½å“ã«ã¯ã‚¢ãƒ«ãƒã‚¸ãƒ­ãƒ»ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ»ãƒ©ã‚¤ã‚»ãƒ³ã‚¹(APL)ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚è©³ç´°ã¯ç†ç§‘ã®ã‚¯ã‚¤ã‚ºã‚²ãƒ¼ãƒ å…¬å¼ã‚µã‚¤ãƒˆã‚’ã”è¦§ãã ã•ã„ã€‚<br>
      ã“ã®ã‚µã‚¤ãƒˆã§ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ / Cookie ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚<br>
      <br>
      ã“ã‚Œã¯é–‹ç™ºä¸­ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã§ã™ã€‚ç¬¬ä¸‰è€…ã¸ã®é…å¸ƒãƒ»å†é…å¸ƒã¯ç¦æ­¢ã—ã¾ã™ã€‚<br>
      copyright&nbsp;2025&nbsp;å¤ªå¹³æ´‹å›½é€£é‚¦ãƒœãƒ¼ãƒ« ï¼ ã‘ã‚‚ãƒ©ãƒœ(ã‚±ãƒ¢ãƒãƒ©ãƒœãƒ©ãƒˆãƒªãƒ¼ã‚ºç ”ç©¶ä¼š)
    </p>
    <button onclick="closePopup()">åŒæ„ã—ã¦é–‰ã˜ã‚‹</button>
  </div>

  <!-- ğŸŒ ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
  <div id="titleScreen" class="screen fade">
    <h1>ç¤¾ä¼šã‚¯ã‚¤ã‚º</h1>
    <span id="highScoreView">ãƒã‚¤ã‚¹ã‚³ã‚¢ï¼š</span><p>
    <button onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button><p>
    <p class="version-text">ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 2.0.3.383&nbsp;inDevâ€‘a238ws58f</p>
  </div>

  <!-- ğŸ“ ã‚¯ã‚¤ã‚ºç”»é¢ -->
  <div id="game" class="screen">
    <div class="score-bar">
      ã‚¹ã‚³ã‚¢ï¼š<span id="liveScore">0</span>
      &nbsp;&nbsp;ãƒŸã‚¹æ®‹ã‚Šï¼š<span id="lives">3</span>&nbsp;å›
    </div>

    <div id="qCard">
      <h2 id="qText">å•é¡ŒãŒè¡¨ç¤ºã•ã‚Œã¾ã™</h2>
      <input type="text" id="answerInput" placeholder="å›ç­”ã‚’å…¥åŠ›" autocomplete="off" />
    </div>

    <div id="timerBar"><div id="timerFill"></div></div>
  </div>

  <!-- ğŸ çµæœç”»é¢ -->
  <div id="result" class="screen fade">
    <h2>ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</h2>
    <p>ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: <span id="score">0</span></p>
    <span id="highScoreViewR">ãƒã‚¤ã‚¹ã‚³ã‚¢ï¼š</span><p>
    <input type="text" id="nameInput" placeholder="åå‰ã‚’å…¥åŠ›" />
    <button onclick="submitRanking()">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²</button>
    <button onclick="goBackHome()">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>

    <h3>ãƒã‚°å ±å‘Šã‚„æ–°è¦ç´ ã®ææ¡ˆã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™</h3>
    <button onclick="openFeedback()">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ä¿¡</button>

    <h2>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
    <label for="rankingType">è¡¨ç¤ºã‚¿ã‚¤ãƒ—ï¼š</label>
    <select id="rankingType">
      <option value="normal">é€šå¸¸ãƒ©ãƒ³ã‚­ãƒ³ã‚°</option>
      <option value="season">ã‚·ãƒ¼ã‚ºãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°</option>
      <option value="weekly">é€±æ›¿ã‚ã‚Šãƒ©ãƒ³ã‚­ãƒ³ã‚°</option>
      <option value="daily">æ—¥æ›¿ã‚ã‚Šãƒ©ãƒ³ã‚­ãƒ³ã‚°</option>
    </select>

    <div id="rankingSection">
      <ul id="rankingList"></ul>
    </div>
  </div>
  <!-- ============================
       ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ JavaScript
       ============================ -->
  <script>
    /* ---------- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---------- */
    const POPUP_KEY = 'popupShown';
    let questions = [];
    let currentIndex = 0;
    let score = 0;
    let lives = 3;
    let timeLeft = 60;
    let timerId = null;
    let gameStarted = false;
    let highScore = localStorage.getItem('highScore') || 0;

    /* ---------- åˆæœŸåŒ– ---------- */
    window.onload = () => {
      document.getElementById('highScoreView').innerText  = `ãƒã‚¤ã‚¹ã‚³ã‚¢ï¼š${highScore}`;
      document.getElementById('titleScreen').style.display = 'none';
      document.getElementById('game').style.display = 'none';
      document.getElementById('result').style.display = 'none';
      if (true) {
        document.getElementById('popup').style.display = 'block';
      } else {
        document.getElementById('titleScreen').style.display = 'block';
      }
    };

    /* ESC ã§å¼·åˆ¶çµ‚äº† */
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && gameStarted) endGame();
    });

    /* ---------- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å‡¦ç† ---------- */
    function closePopup() {
      localStorage.setItem(POPUP_KEY, 'true');
      document.getElementById('popup').style.display = 'none';
      document.getElementById('titleScreen').style.display = 'block';
    }

    /* ---------- ã‚²ãƒ¼ãƒ é–‹å§‹ ---------- */
    function startGame() {
  console.log('startGame() é–‹å§‹');

  score = 0;
  lives = 3;
  currentIndex = 0;
  gameStarted = true;

  document.getElementById('titleScreen').style.display = 'none';
  document.getElementById('game').style.display = 'block';
  document.getElementById('liveScore').innerText = score;
  document.getElementById('lives').innerText = lives;

  google.script.run.withSuccessHandler(data => {
    console.log('getRandomQuestions æˆåŠŸ:', data);
    
    if (!data || !Array.isArray(data) || data.length === 0) {
      alert('å•é¡ŒãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
      return;
    }

    questions = data;
    showQuestion(); // âœ… ã“ã“ã§åˆã‚ã¦ã‚²ãƒ¼ãƒ ãŒé€²è¡Œ
  }).getRandomQuestions();
}


    /* ---------- å•é¡Œè¡¨ç¤º ---------- */
    function showQuestion() {
      const q = questions[currentIndex];
      document.getElementById('qText').innerText = q.question;
      document.getElementById('answerInput').value = '';
      document.getElementById('answerInput').focus();

      timeLeft = 60;
      updateTimerBar();
      clearInterval(timerId);
      timerId = setInterval(() => {
        timeLeft--;
        updateTimerBar();
        if (timeLeft <= 0) {
          clearInterval(timerId);
          wrongAnswer();
        }
      }, 1000);
    }

    /* ---------- ã‚¿ã‚¤ãƒãƒ¼ãƒãƒ¼æ›´æ–° ---------- */
    function updateTimerBar() {
      document.getElementById('timerFill').style.width = (timeLeft / 60) * 100 + '%';
    }

    /* ---------- å›ç­”ãƒã‚§ãƒƒã‚¯ ---------- */
    document.getElementById('answerInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') checkAnswer();
    });

    function checkAnswer() {
  if (!questions[currentIndex]) return endGame();

  const userAnswer = document.getElementById('answerInput').value.trim();
  const correctAnswer = questions[currentIndex].answer.toString().trim();

  if (userAnswer === correctAnswer) {
    correctAnswerFunc(); // æ­£è§£æ™‚ã®å‡¦ç†
  } else {
    wrongAnswer(); // é–“é•ã„å‡¦ç†
  }
}


    /* ---------- æ­£è§£ / ä¸æ­£è§£ ---------- */
    function correctAnswerFunc() {
  clearInterval(timerId);
  score += 100;
  document.getElementById('liveScore').innerText = score;

  const gameEl = document.getElementById('game');
  gameEl.classList.remove('wrong-anim');
  gameEl.classList.add('correct-anim');

  setTimeout(() => {
    gameEl.classList.remove('correct-anim');
    currentIndex++;
      showQuestion();
  }, 400);
}


    function wrongAnswer() {
      clearInterval(timerId);
      lives--;
      document.getElementById('lives').innerText = lives;

      const qCard = document.getElementById('qCard');
      const ansP  = document.createElement('p');
      ansP.id = 'answerDisplay';
      ansP.innerText = `æ­£è§£ï¼š${questions[currentIndex].answer}`;
      ansP.style.cssText = 'color:#d32f2f;font-size:1.2em;animation:fadein 0.8s;';
      qCard.appendChild(ansP);

      document.getElementById('game').classList.add('wrong-anim');
      setTimeout(() => {
        document.getElementById('game').classList.remove('wrong-anim');
        ansP.remove();
        (lives <= 0) ? endGame() : (currentIndex++, showQuestion());
      }, 1500);
    }

    /* ---------- ã‚²ãƒ¼ãƒ çµ‚äº† ---------- */
    function endGame() {
      clearInterval(timerId);
      gameStarted = false;

      document.getElementById('game').style.display   = 'none';
      document.getElementById('result').style.display = 'block';
      document.getElementById('score').innerText      = score;

      // ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°
      if (score > highScore) {
        highScore = score;
        localStorage.setItem('highScore', highScore);
        document.getElementById('highScoreViewR').innerText = `ãƒã‚¤ã‚¹ã‚³ã‚¢ï¼š${highScore}ã€€ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°!!`;
        document.getElementById('highScoreView').innerText  = `ãƒã‚¤ã‚¹ã‚³ã‚¢ï¼š${highScore}`;
      } else {
        document.getElementById('highScoreViewR').innerText = `ãƒã‚¤ã‚¹ã‚³ã‚¢ï¼š${highScore}`;
      }

      // é€šå¸¸ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—
      google.script.run.withSuccessHandler(showRanking).getRankingBySheet('ãƒ©ãƒ³ã‚­ãƒ³ã‚°');
    }

    /* ---------- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ² ---------- */
    function submitRanking() {
      const name = document.getElementById('nameInput').value.trim();
      if (!name) return alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');

      google.script.run.withSuccessHandler(() => {
        alert('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²ã—ã¾ã—ãŸï¼');
        google.script.run.withSuccessHandler(showRanking).getRankingBySheet('ãƒ©ãƒ³ã‚­ãƒ³ã‚°');
      }).submitScore({ name, score });
    }

    /* ---------- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º ---------- */
    document.getElementById('rankingType').addEventListener('change', e => {
      const sheetName = getSheetLabel(e.target.value);
      google.script.run.withSuccessHandler(showRanking).getRankingBySheet(sheetName);
    });

    function getSheetLabel(type) {
      const now   = new Date();
      const y     = now.getFullYear();
      const m     = String(now.getMonth() + 1).padStart(2, '0');
      const d     = String(now.getDate()).padStart(2, '0');
      const week  = Math.ceil((now.getDate() - 1 + new Date(y, now.getMonth(), 1).getDay()) / 7);

      if (type === 'season') return `Season_${y}_${m}`;
      if (type === 'weekly') return `Week_${y}_W${week}`;
      if (type === 'daily')  return `Day_${y}_${m}_${d}`;
      return 'ãƒ©ãƒ³ã‚­ãƒ³ã‚°';
    }

    function showRanking(rows) {
      const ul = document.getElementById('rankingList');
      ul.innerHTML = '';
      rows.sort((a, b) => b[1] - a[1]);           // ã‚¹ã‚³ã‚¢é™é †
      rows.slice(0, 30).forEach(r => {            // ä¸Šä½30ä»¶
        const li = document.createElement('li');
        li.textContent = `${r[0]}ï¼š${r[1]}ç‚¹ (${new Date(r[2]).toLocaleDateString()})`;
        ul.appendChild(li);
      });
    }

    /* ---------- ãã®ä»–ã® UI æ“ä½œ ---------- */
    function goBackHome() {
      document.getElementById('result').style.display      = 'none';
      document.getElementById('titleScreen').style.display = 'block';
    }

    function openFeedback() {
      window.open('https://example.com/feedback', '_blank');
    }
  </script>
</body>
</html>
